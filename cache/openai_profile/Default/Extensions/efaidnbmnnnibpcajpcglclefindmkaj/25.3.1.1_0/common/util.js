/*************************************************************************
* ADOBE CONFIDENTIAL
* ___________________
*
*  Copyright 2015 Adobe Systems Incorporated
*  All Rights Reserved.
*
* NOTICE:  All information contained herein is, and remains
* the property of Adobe Systems Incorporated and its suppliers,
* if any.  The intellectual and technical concepts contained
* herein are proprietary to Adobe Systems Incorporated and its
* suppliers and are protected by all applicable intellectual property laws,
* including trade secret and or copyright laws.
* Dissemination of this information or reproduction of this material
* is strictly forbidden unless prior written permission is obtained
* from Adobe Systems Incorporated.
**************************************************************************/
import{common as e}from"../sw_modules/common.js";import{util as t}from"../sw_modules/util.js";import{dcLocalStorage as a}from"./local-storage.js";import{ADOBE_URL as n}from"./constant.js";import{EXPERIMENT_VARIANTS_STORAGE_KEY as r}from"../sw_modules/constant.js";export function isNewUser(){if(!a.getItem("extUserState")){const e=a.getItem("viewerStorage");if(e){return+(0===(parseInt(e.usage)||0))}return-1}return 0}export async function updateExtUserState(){if(!a.getItem("extUserState")){a.setItem("extUserState","ru");const e=await chrome.tabs.query({active:!0,lastFocusedWindow:!0});chrome.runtime.sendMessage({main_op:"reRegisterUninstallUrl",tab:e[0]})}}const o={MACHINE:"machine"};export function setCookie(e,t,a={}){const n={name:e,value:t,secure:!0,sameSite:"no_restriction"};a.url&&(n.url=a.url),a.path&&(n.path=a.path),a.expiryDate&&(n.expirationDate=a.expiryDate),a.sameSite&&(n.sameSite=a.sameSite),a.secure&&(n.secure=a.secure),a.domain&&(n.domain=a.domain),chrome.cookies.set(n)}export function isISOString(e){const t=new Date(e);return!Number.isNaN(t.valueOf())&&t.toISOString()===e}export function registerUninstallUrl({locale:n}={}){const o=a.getItem("appLocale"),s=a.getItem("installSource");if(["development","normal","sideload"].includes(s)){const s=new URL(e.getUninstallUrl());if(o)s.searchParams.append("locale",o);else if(n)s.searchParams.append("locale",n);else{let e=a.getItem("viewer-locale")||t.getFrictionlessLocale(chrome.i18n.getMessage("@@ui_locale"));s.searchParams.append("locale",e)}s.searchParams.append("theme",a.getItem("theme")||"auto"),s.searchParams.append("callingApp",chrome.runtime.id),s.searchParams.append("nu",isNewUser());let i=[];const c=function(){let e="";return"true"===a.getItem("gmail-pdf-dv-feature-enablement-status")?e+="Tr":"true"===a.getItem("gmail-pdf-dv-feature-control-enablement-status")&&(e+="Ctrl"),e&&(e="GMSfceDV_"+e+"_",e+="true"===a.getItem("gmail-pdf-default-viewership")?"T":"F"),e}();c&&i.push(c);const m=a.getItem(r);Array.isArray(m)&&m.length>0&&i.push(...m),i.length>0&&s.searchParams.append("acEx",JSON.stringify(i.sort())),chrome.runtime.setUninstallURL(s.href)}}async function s(e,t=void 0){const a=new Date,r=a.getMonth(),s=a.getFullYear();let i="mmac";e===o.MACHINE&&(i+="_machine"),t&&(i+=`_${t}`);let c=null;try{c=await chrome.cookies.get({url:n,name:i});const e=!c||function(e,t,a){const n=new Date(e),r=n.getMonth(),o=n.getFullYear();return a>o||a===o&&t>r}(c.value,r,s);return!e}catch(e){return!1}}function i(t){const a=e.getAcroIpmURL(),n=new URL(a);return t.pingType===o.MACHINE&&(n.pathname+="/machine"),t.appPath?n.pathname+=`/${encodeURIComponent(t.appPath)}`:n.pathname+="/overall",Object.keys(t.schema).forEach((e=>{const a=t.schema[e];n.pathname+=a?`/${encodeURIComponent(a)}`:"/unspecified"})),n.pathname+="/mmac.html",n.toString()}async function c(e,t,a=void 0){try{const r=await fetch(e);if(200===r?.status){let e="mmac";t===o.MACHINE&&(e+="_machine"),a&&(e+=`_${a}`);const r=new Date,s=Math.floor(Date.now()/1e3)+2678400;setCookie(e,r.toISOString(),{url:n,expiryDate:s,path:"/",domain:".adobe.com"})}}catch(e){console.error(e)}}async function m(e){if(async function(e){e&&!await s(o.MACHINE)&&c(i({...e,appPath:void 0,pingType:o.MACHINE}),o.MACHINE)}(e),function(e){return!!e&&!(!e.appPath||"string"!=typeof e.appPath||""===e.appPath.trim())}(e)&&!await s(o.MACHINE,e.appPath)){c(i({...e,pingType:o.MACHINE}),o.MACHINE,e.appPath)}}export function sendPingEventHandler(){let e="chrome-extension";t.isEdge()&&(e="edge-extension");const n=a.getItem("appLocale");let r=a.getItem("viewer-locale");r||(r=a.getItem("locale")),m({appPath:e,schema:{appIdentifier:"dc-acrobat-extension",appVersion:chrome.runtime.getManifest().version,appReferrer:a.getItem("installSource"),userType:"unknown",subscriptionType:"unknown",locale:n||r}})}export const isEdgeBrowser=()=>t.isEdge();export const isChromeViewerOpened=e=>{if(!e)return!1;const t=`chrome-extension://${chrome.runtime.id}`;return e.startsWith(`${t}/http`)||e.startsWith(`${t}/https`)||e.startsWith(`${t}/viewer.html`)||e.startsWith(`${t}/file`)};