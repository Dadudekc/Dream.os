/*************************************************************************
* ADOBE CONFIDENTIAL
* ___________________
*
*  Copyright 2015 Adobe Systems Incorporated
*  All Rights Reserved.
*
* NOTICE:  All information contained herein is, and remains
* the property of Adobe Systems Incorporated and its suppliers,
* if any.  The intellectual and technical concepts contained
* herein are proprietary to Adobe Systems Incorporated and its
* suppliers and are protected by all applicable intellectual property laws,
* including trade secret and or copyright laws.
* Dissemination of this information or reproduction of this material
* is strictly forbidden unless prior written permission is obtained
* from Adobe Systems Incorporated.
**************************************************************************/
import{analytics as e,events as t}from"../common/analytics.js";import{dcLocalStorage as r,dcSessionStorage as n}from"../common/local-storage.js";import{loggingApi as o}from"../common/loggingApi.js";import{CACHE_PURGE_SCHEME as s,EXPERIMENT_VARIANTS_STORAGE_KEY as a,EXPRESS as c}from"./constant.js";import{floodgate as i}from"./floodgate.js";import{util as m}from"./util.js";import{viewerModuleUtils as l}from"./viewer-module-utils.js";import{common as E}from"./common.js";import{expressIndexedDBScript as u}from"../common/expressindexedDB.js";let p=!1;const d={},g="expressMenu",x={"dc-cv-express-context-menu":"Exp_Mod","dc-cv-express-context-menu-ab":"Exp_Mod_ab","dc-cv-express-standalone":"Exp_Loe"},f="cleanUpExpressAssetMemoryMap",S="cleanUpExpressIndexedDB",_={beta:["memepcobodlebmohdlfnjiaalggfcpic","hgednelcgbmkdebjhejlmbgigmkcbemg"],release:["efaidnbmnnnibpcajpcglclefindmkaj","elhekieabhbkpmcefcoobjddigjcaadp"]},I={[c.VERBS.CROP_IMAGE]:"crop-image",[c.VERBS.REMOVE_BACKGROUND_IMAGE]:"remove-background"};async function A(e){const t=Date.now(),r=await fetch(e);if(!r.ok)throw new Error("Response not in 2xx range");const n=await r.blob();return new Promise(((e,r)=>{const o=new FileReader;o.readAsDataURL(n),o.onloadend=()=>{const r=o.result,n=Date.now()-t;e({base64data:r,imageDownloadTime:n})},o.onerror=r}))}async function R(e){if(!await i.hasFlag(e))return!1;const t=i.getFeatureMeta(e);if(t)try{const e=JSON.parse(t);if(e.minExtVer&&m.verCmp(e.minExtVer,chrome.runtime.getManifest().version)>0)return!1}catch(e){}return!0}function T(e){return I[e]??"edit-image"}async function b(s,a){let l;r.setItem(c.CONTEXT_MENU_INTERACTION_DONE,"true");try{if(l=s.menuItemId.replace("ContextMenu",""),await i.hasFlag("dc-cv-express-standalone")){const e=m.uuid(),t=Date.now(),n=t+864e5;u.storeExpressAssetInfoInIndexedDB(e,s.srcUrl,n,t),chrome.alarms.get(S,(e=>{e||chrome.alarms.create(S,{periodInMinutes:720})})),d[e]={bufferPromise:A(s.srcUrl),ttl:Date.now()+6e5,clickTimeStamp:t},chrome.alarms.get(f,(e=>{e||chrome.alarms.create(f,{periodInMinutes:10})}));const o=new URL(E.getExpressURLs().webAppUrl);o.searchParams.append("expressSessionId",e),o.searchParams.append("referrer",c.REFERRER);const a=T(s.menuItemId.replace("ContextMenu",""));o.searchParams.append("editAction",a),o.searchParams.append("extId",function(){const e=Object.keys(_).filter((e=>_[e].includes(chrome.runtime.id)));return e.length>0?e[0]:"release"}());const i=r.getItem("appLocale")||m.getFrictionlessLocale(chrome.i18n.getMessage("@@ui_locale"));o.searchParams.append("locale",i),chrome.tabs.create({url:o.href,active:!0})}else!function(e){let t=n.getItem(c.TAB_IDS_WHERE_MODAL_LOADING)||[];t.push(e),n.setItem(c.TAB_IDS_WHERE_MODAL_LOADING,t)}(a.id),r.setItem(c.CONTEXT_MENU_ON_CLICK_INFO_LOCAL_STORAGE_KEY,s),await chrome.scripting.executeScript({target:{tabId:a.id},files:["content_scripts/express-content-script.js"]})}catch(r){N(a.id,!0),e.event(t.EXPRESS_EXECUTE_VERB_FAILED,{VERB:l,eventContext:r.toString()}),o.error({message:"Error executing express verb",error:"Initiate execute verb from service worker: "+r.toString()})}}async function h(n){if(!d[n])return async function(r){let n,s,a;const i=await u.getExpressAssetInfoFromIndexedDB(r);if(!i)return o.error({message:"Error executing express verb",error:`Asset transfer to LOE failed: ${c.EXTERNAL_MESSAGING_ERROR_CODES.INVALID_REQUEST}`}),{status:c.RESPONSE_STATUS.FAILED,errorCode:c.EXTERNAL_MESSAGING_ERROR_CODES.INVALID_REQUEST};n=i.url,s=i.clickTimeStamp;try{a=(await A(n)).base64data}catch(r){return e.event(t.EXPRESS_EXECUTE_VERB_FAILED,{eventContext:r.toString()}),o.error({message:"Error executing express verb",error:`Asset transfer to LOE failed: ${r.toString()}`}),{status:c.RESPONSE_STATUS.FAILED,errorCode:c.EXTERNAL_MESSAGING_ERROR_CODES.IMAGE_FETCH_FAILED,clickTimeStamp:s}}return{status:c.RESPONSE_STATUS.SUCCESS,buffer:a,clickTimeStamp:s}}(n);{const s=d[n].clickTimeStamp,a=Date.now()-s;try{const{base64data:e,imageDownloadTime:t}=await d[n].bufferPromise,i=Date.now()-s;"true"===r.getItem("adobeInternal")&&(console.log("Time required to receive request from express webapp "+a),console.log("Image Download Time "+t),console.log("Time required to handover to express "+i));const m={imageDownloadTime:t,timeRequiredToHandoverToExpress:i,expressCommunicationReceivedTime:a,imageSize:e.length};return o.info({message:c.PERF_METRIC_LOG_MESSAGE,...m}),{status:c.RESPONSE_STATUS.SUCCESS,buffer:e,clickTimeStamp:s}}catch(r){e.event(t.EXPRESS_EXECUTE_VERB_FAILED,{eventContext:r.toString()}),o.error({message:"Error executing express verb",error:`Asset transfer to LOE failed: ${r.toString()}`});const n=c.EXTERNAL_MESSAGING_ERROR_CODES.IMAGE_FETCH_FAILED;return{status:c.RESPONSE_STATUS.FAILED,errorCode:n,clickTimeStamp:s}}}}function O(e){chrome.scripting.executeScript({target:{tabId:e},func:()=>{!function(e){const t=document.querySelector(`#${e}`);t?.parentElement?.removeChild(t),document.body.style.overflow="auto"}("expressAcrobatExtension"),dialogToBeReopened&&(dialogToBeReopened.showModal(),dialogToBeReopened=void 0)}})}function D(){const e=Object.values(x);return(r.getItem(a)||[]).find((t=>e.includes(t)))}function M(){const e=r.getItem("appLocale")||m.getFrictionlessLocale(chrome.i18n.getMessage("@@ui_locale")),t="true"===r.getItem("adobeInternal"),n=r.getItem("installSource");return["en-US","en-GB"].includes(e)&&(t||"admin"!==n)}async function C(e){const t=["http://*/*","https://*/*"];if((await v(e)).enableExpressContextMenu){if(!p){p=!0;const e=L(g,m.getTranslation("expressEditImageParentContextMenu"),["image"],t);chrome.contextMenus.create({id:"poweredByAdobeExpress",parentId:e,title:m.getTranslation("expressEditImagePoweredByExpressContextMenu"),contexts:["image"],enabled:!1,documentUrlPatterns:t}),chrome.contextMenus.create({id:"separatorForExpressMenu",parentId:e,type:"separator",contexts:["image"],documentUrlPatterns:t}),Object.keys(c.VERBS).forEach((r=>{const n=c.VERBS[r]+"ContextMenu";L(n,m.getTranslation(n),["image"],t,e)}))}const e=await i.hasFlag("dc-cv-enable-splunk-logging",s.NO_CALL);l.enableSplunk(e)}else p&&(p=!1,chrome.contextMenus.remove("poweredByAdobeExpress"),chrome.contextMenus.remove("separatorForExpressMenu"),Object.keys(c.VERBS).forEach((e=>{const t=c.VERBS[e]+"ContextMenu";chrome.contextMenus.remove(t)})),chrome.contextMenus.remove(g))}async function v(n){let o={enableExpressContextMenu:!1,enableExpressOptionsPagePreference:!1,enableExpressTooltip:!1};const s=await i.hasFlag("dc-cv-express-context-menu")||await R("dc-cv-express-context-menu-ab")||await R("dc-cv-express-standalone"),m=await i.hasFlag("dc-cv-express-context-menu-tooltip"),l=await i.hasFlag("dc-cv-express-context-menu-pref-value");if(null!=n&&""!==n||null!=(n=r.getItem("express-touch-points"))&&""!==n||(n=l),await async function(){let e=r.getItem(a)||[];const t=M();for(const r of Object.keys(x)){const n=x[r];t&&await R(r)?e.includes(n)||e.push(n):e.includes(n)&&(e=e.filter((e=>e!==n)))}r.setItem(a,e)}(),s&&M()&&("true"!==r.getItem("express-context-menu-fg-enabled-analytics-logged")&&(r.setItem("express-context-menu-fg-enabled-analytics-logged","true"),e.event(t.EXPRESS_CONTEXT_MENU_FG_ENABLED)),o.enableExpressOptionsPagePreference=!0,n&&"false"!==n)){o.enableExpressContextMenu=!0;const e="true"===r.getItem(c.CONTEXT_MENU_INTERACTION_DONE);o.enableExpressTooltip=!e&&m}return o}function L(e,t,r,n,o){return chrome.contextMenus.create({id:e,parentId:o,title:t,contexts:r,documentUrlPatterns:n})}function w(r){const n=N(r);for(let r=0;r<n;r++){const r="Tab closed before express modal opened";o.error({message:"Error executing express verb",error:r}),e.event(t.EXPRESS_TAB_CLOSED_BEFORE_EXPRESS_LOADED,{eventContext:r})}}function N(e,t=!1){let r=0,o=n.getItem(c.TAB_IDS_WHERE_MODAL_LOADING)||[];return o.length>0&&o.includes(e)&&(o=o.filter((n=>{if(n===e){if(r++,t&&1===r)return!1;if(!t)return!1}return!0})),n.setItem(c.TAB_IDS_WHERE_MODAL_LOADING,o)),r}chrome.alarms.onAlarm.addListener((function(e){e&&e.name===f&&(Object.keys(d).forEach((e=>{d[e]?.ttl<Date.now()&&delete d[e]})),0===Object.keys(d).length&&chrome.alarms.clear(f))})),chrome.alarms.onAlarm.addListener((function(e){e&&e.name===S&&u.removeExpressAssetInfoFromIndexedDB().then((()=>{u.getExpressAssetCount().then((e=>{0===e&&chrome.alarms.clear(S)}))}))}));export{b as executeExpressVerb,O as closeExpress,C as toggleExpressTouchpoints,v as isExpressContextMenuEnabled,D as getActiveExperimentAnalyticsString,h as getExpressAssetResponse,A as imageUrlToBase64,T as verbNameToIntent,N as removeTabIdFromUnloadedExpressTabs,w as expressModalTabCloseListener};