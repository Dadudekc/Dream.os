/*************************************************************************
* ADOBE CONFIDENTIAL
* ___________________
*
*  Copyright 2015 Adobe Systems Incorporated
*  All Rights Reserved.
*
* NOTICE:  All information contained herein is, and remains
* the property of Adobe Systems Incorporated and its suppliers,
* if any.  The intellectual and technical concepts contained
* herein are proprietary to Adobe Systems Incorporated and its
* suppliers and are protected by all applicable intellectual property laws,
* including trade secret and or copyright laws.
* Dissemination of this information or reproduction of this material
* is strictly forbidden unless prior written permission is obtained
* from Adobe Systems Incorporated.
**************************************************************************/
import state from"./state.js";import{sendAnalyticsOncePerMonth}from"../gsuite/util.js";const FILE_DATA_ID_ATTRIBUTE="data-id",GDRIVE_TOUCH_POINT_CLASS="acrobat-gdrive-touch-point",GDRIVE_PDF_ELEMENT_PROCESSED="acrobat-processed",GDRIVE_PDF_ELEMENT_EXCLUDED="acrobat-excluded",checkDivImageType=(e,t)=>{const r=e?.getElementsByTagName("path");if(r&&r.length>0){const e=r[0]?.getAttribute("d");if(t?.includes(e))return!0}return!1},isFileElementSelected=e=>{const t="true"===e.getAttribute("aria-selected"),r="true"===e?.childNodes[0]?.getAttribute("aria-selected");return t||r},getSelectedFiles=e=>Array.from(e).filter((e=>isFileElementSelected(e))),getEligiblePdfFileElementList=(e,t,r)=>e.filter((e=>{if(e.hasAttribute("acrobat-excluded"))return!1;const i=0===e.getElementsByClassName(GDRIVE_TOUCH_POINT_CLASS)?.length,s=checkDivImageType(e,t),l=getElementListForSelectors(r?.exclude,e)?.length>0;return i&&s&&!l?(e.setAttribute("acrobat-processed",!0),!0):(s&&!l||e.setAttribute("acrobat-excluded","true"),!1)})),getElementListForSelectors=(e=[],t=null)=>{const r=new Set,i=t||document;for(const t of e){const e=i?.getElementsByClassName(t);if(e?.length>0){const t=Array.from(e);t?.forEach((e=>r.add(e)))}}return Array.from(r)},setDrivePath=()=>{const e=window.location.pathname;if(""!==state?.driveUrlPath&&state?.prevDriveUrlPath===e)return state?.driveUrlPath;const t=e?.split("/");return t?.length>=3&&(t?.length>=5&&"u"===t[2]?state.driveUrlPath=t[4]:t?.length>=3&&(state.driveUrlPath=t[2])),state.prevDriveUrlPath=e,state?.driveUrlPath},getSelectorsForCurrentPathAndSelectedView=()=>{const e={fileElement:[],fileTitle:[],touchpointContainer:[]},t=state?.config?.selectors[state?.selectedView];let r=state?.driveUrlPath;return"spam"!==r&&"workspaces"!==r&&t?.pathSelector?(t?.pathSelector[r]||(r="default"),t?.pathSelector[r]):e},setSelectedView=()=>{state?.config?.enableGDriveListViewTouchPoint&&state?.config?.selectors?.GoogleDriveListView&&(checkViewToggleButton(state?.config?.selectors?.GoogleDriveListView)||"quota"===state?.driveUrlPath)?state.selectedView="GoogleDriveListView":state?.config?.enableGDriveGridViewTouchPoint&&state?.config?.selectors?.GoogleDriveGridView&&checkViewToggleButton(state?.config?.selectors?.GoogleDriveGridView)&&(state.selectedView="GoogleDriveGridView")},checkViewToggleButton=e=>{const t=e?.currView,r=t?.btnKey,i=getElementListForSelectors(t?.viewBtn);if(i?.length>=0){if(0===i[0]?.childNodes?.length)return!1;const e=i[0]?.childNodes[r];if(!e)return!1;return"true"===e.getAttribute("aria-checked")}return"quota"!==state?.driveUrlPath&&sendAnalyticsOncePerMonth(`DCBrowserExt:GDrive:${state?.selectedView+"-"+state?.driveUrlPath}:ViewButtonNotPresent`),!1},createUrlForAcrobatTouchPoint=(e,t)=>{const r=`https://drive.usercontent.google.com/download?id=${e?.id}&authuser=${state?.userId}&acrobatPromotionSource=${t}`;return chrome.runtime.getURL("viewer.html")+"?pdfurl="+encodeURIComponent(r)+"&pdffilename="+encodeURIComponent(e?.title)},createCustomClassNameBasedOnViewAndPath=(e,t,r)=>"GoogleDriveListView"===t?`${e}-${t}`:"GoogleDriveGridView"===t?"home"===r||"recent"===r?`${e}-${t}-${r}`:`${e}-${t}`:"",getPdfFileDetails=(e,t)=>{const r={id:"",title:""},i=e.getAttribute("data-id"),s=getElementListForSelectors(t?.fileTitle,e);if(i&&(r.id=i),s?.length>0){const e=s[0]?.innerText;e&&isFileTypePdfInTitle(e)&&(r.title=e)}return r},isFileTypePdfInTitle=e=>e.endsWith(".pdf")||e.endsWith(".PDF"),isEventTargetWithinElement=(e,t)=>!!t&&t.contains(e?.target),areFilesPdfs=e=>{if(!e)return!1;const t=Array.isArray(e)?e:[e];if(0===t.length)return!1;const r=state?.config?.selectors[state?.selectedView]?.pdfSvgPath;return t.every((e=>checkDivImageType(e,r)))},buildClassSelectorString=e=>e?e.map((e=>`.${e}`)).join(","):"";export{createUrlForAcrobatTouchPoint,createCustomClassNameBasedOnViewAndPath,getEligiblePdfFileElementList,getElementListForSelectors,getSelectorsForCurrentPathAndSelectedView,getSelectedFiles,getPdfFileDetails,setDrivePath,setSelectedView,isFileElementSelected,isEventTargetWithinElement,areFilesPdfs,buildClassSelectorString};