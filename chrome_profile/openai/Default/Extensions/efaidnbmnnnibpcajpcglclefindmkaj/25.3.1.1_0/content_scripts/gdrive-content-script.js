/*************************************************************************
* ADOBE CONFIDENTIAL
* ___________________
*
*  Copyright 2015 Adobe Systems Incorporated
*  All Rights Reserved.
*
* NOTICE:  All information contained herein is, and remains
* the property of Adobe Systems Incorporated and its suppliers,
* if any.  The intellectual and technical concepts contained
* herein are proprietary to Adobe Systems Incorporated and its
* suppliers and are protected by all applicable intellectual property laws,
* including trade secret and or copyright laws.
* Dissemination of this information or reproduction of this material
* is strictly forbidden unless prior written permission is obtained
* from Adobe Systems Incorporated.
**************************************************************************/
(()=>{const e="-shared",t="acrobatDisconnectContentScriptStart",n="acrobatContentScriptDisconnectEnd",o="acrobat-prompt",i="acrobat-fte-tooltip-container",r="acrobat-gdrive-fte-state",a="80763634447";let s,c,d,l,u,m,p=!1,g=!1;const v=()=>!chrome.runtime?.id,h=()=>window.location.pathname.includes("/file"),w=e=>{m?.sendAnalytics(e)},f=t=>{if(p||t){const t=document.getElementsByClassName(o);if(t?.length>0){const e=t[0].getElementsByClassName(i);e?.length>0&&w(["DCBrowserExt:GdriveFTE:NativeView:Dismissed"]),t[0].remove()}const n=document.getElementsByClassName(o+e);n?.length>0&&n[0].remove();const r=document.getElementById("acrobat-prompt");r?.remove(),p=!1}},E=()=>((e,t)=>{if(e){const n=l?.config?.selectors,o=n&&n[t];for(let t=0;t<o?.length;t++){let n=e.querySelector(o[t]);if(n)return n}}return null})(document,"fileDetails"),b=e=>{try{return JSON.parse(e?.textContent?.replace(/\\/g,""))}catch(e){return null}},y=e=>{if("Enter"===e.key||32===e.keyCode||"click"===e.type){if(v())return void f();const{acrobatTouchPointClicked:t,getAcrobatTouchPointFteEligibility:n}=u;t(r),l.fteToolTip.touchPointClicked=!0;const o=E(),i=b(o);let a="DCBrowserExt:Gdrive:OpenInExtension:Clicked";"Enter"===e.type&&(a="DCBrowserExt:Gdrive:OpenInExtension:EnterKeyDown"),32===e.keyCode&&(a="DCBrowserExt:Gdrive:OpenInExtension:SpaceKeyDown"),w([[a,{gsuiteFte:n(l?.config?.enableFteToolTip)}]]);const s=chrome.runtime.getURL("viewer.html")+"?pdfurl="+encodeURIComponent(`https://drive.usercontent.google.com/download?id=${i.id}&authuser=${l?.userId}&acrobatPromotionSource=GoogleDriveNativeView`)+"&pdffilename="+encodeURIComponent(i.title);window.open(s,"_blank")}},C=()=>{const t=document.createElement("div"),n=(()=>{const e=document.createElement("img");e.setAttribute("src",chrome.runtime.getURL("browser/images/acrobat_dc_appicon_128.png"));const t=h()?"acrobat-icon-shared":"acrobat-icon";return e.setAttribute("class",t),e})(),i=(()=>{const e=document.createElement("span"),t=h()?"acrobat-prompt-text-shared":"acrobat-prompt-text";return e.setAttribute("class",t),e.textContent=l?.config?.acrobatPromptText||"Edit with Acrobat",e})(),r=(()=>{const e=document.createElement("div"),t=h()?"acrobat-prompt-tooltip":"acrobat-prompt-tooltip-shared";return e.setAttribute("class",t),e.textContent=l?.config?.acrobatPromptText||"Open in Acrobat",e})(),a=h()?o+e:o;return t.setAttribute("class",a),t.appendChild(n),t.appendChild(r),t.appendChild(i),t.tabIndex=0,t.addEventListener("keydown",(e=>{y(e)}),{signal:l?.eventControllerSignal}),t.addEventListener("click",(e=>{y(e)}),{signal:l?.eventControllerSignal}),t},T=e=>{const t=document.getElementsByClassName(i);"Enter"!==e.key&&"ArrowLeft"!==e.key&&"ArrowRight"!==e.key&&"click"!==e.type||t?.length>0&&(t[0]?.contains(e.target)||(t[0].remove(),w(["DCBrowserExt:GdriveFTE:NativeView:Dismissed"]),document.removeEventListener("click",T),document.removeEventListener("keydown",T)))},A=e=>{const{createFteTooltip:t}=u,n=t(l?.config?.fteToolTipStrings,"gdriveNativeView");(e=>{e.querySelector(".acrobat-fte-tooltip-button").addEventListener("click",(()=>{e.remove(),w(["DCBrowserExt:GdriveFTE:NativeView:Clicked"]),document.removeEventListener("click",T),document.removeEventListener("keydown",T)}))})(n),document.addEventListener("click",T,{signal:l?.eventControllerSignal}),document.addEventListener("keydown",T,{signal:l?.eventControllerSignal}),e.appendChild(n),w(["DCBrowserExt:GdriveFTE:NativeView:Shown"]);const{updateFteToolTipCoolDown:o}=u;o(l?.config?.fteConfig?.tooltip,r).then((e=>{l.fteToolTip={...l?.fteToolTip,...e}}))},D=()=>{try{if(p)return;const t=C(),n=(()=>{let e;for(let t=0;t<l?.config?.selectors?.promptParentElement.length&&(e=document.querySelector(l?.config?.selectors?.promptParentElement[t]),!e);t++);return e})(),i=h()?o+"-"+e:o;if(n&&0===n?.getElementsByClassName(i)?.length){if(n.prepend(t),p=!0,window.innerWidth>1080){w([["DCBrowserExt:Gdrive:OpenInExtension:Shown",{gsuiteFte:u?.getAcrobatTouchPointFteEligibility(l?.config?.enableFteToolTip)}]]);const{shouldShowFteTooltip:e}=u,n=l?.config?.fteConfig?.tooltip;e(n,l?.fteToolTip,l?.config?.enableFteToolTip).then((e=>{e&&setTimeout((()=>{A(t)}),1e3)}))}}else f()}catch(e){f()}},O=()=>{const e=E();if(e){const t=b(e);"application/pdf"===t?.mimeType?D():f(),(e=>{l&&!l?.analyticsForImageOpenedSent&&e?.mimeType?.startsWith("image/")&&(m?.sendAnalyticsOncePerMonth("DCBrowserExt:Gdrive:Image:Opened",{eventContext:e.mimeType}),l.analyticsForImageOpenedSent=!0)})(t)}else f()},S=()=>{try{O(),l?.pageLoaded&&c?.processForTouchPoint()}catch(e){}},x=()=>{if(document?.body)try{const e={childList:!0,subtree:!0,attributes:!0,attributeFilter:["style"]};d=new MutationObserver((function(){d.takeRecords(),v()?(d.disconnect(),f(),c?.removeAllTouchPoints(),l?.disconnectEventListeners()):S()})),d.observe(document?.body,e)}catch(e){}else setTimeout(x,500)},L=()=>{f(!0),c?.removeAllTouchPoints()},F=()=>{v()&&(d&&d.disconnect(),f(),l?.disconnectEventListeners(),window.dispatchEvent(new CustomEvent(n,{detail:{state:l.createStateTransferObject()}})))},P=()=>{window.addEventListener(n,(e=>(e=>{v()||l.updateStateFromTransferObject(e?.detail?.state)})(e)),{signal:l?.eventControllerSignal}),window.dispatchEvent(new Event("orphanContentScript")),window.dispatchEvent(new Event(t)),window.addEventListener(t,F,{signal:l?.eventControllerSignal})},k=()=>{chrome.runtime.sendMessage({main_op:"gdrive-init"},(async e=>{e?.acrobatTouchPointEnabled&&(B(e),await(e=>{const t=chrome.runtime.getURL("content_scripts/gdrive/state.js");return import(t).then((t=>{l=t.default,l.config=e,l.acrobatIconPath="browser/images/acrobat_dc_trefoil_24_white.svg"}))})(e),P(),(e?.enableOpenInExtension||window.location?.search?.includes("enableAcrobatPromptInGSuite"))&&(()=>{const e=chrome.runtime.getURL("content_scripts/gsuite/fte-utils.js"),t=chrome.runtime.getURL("content_scripts/gdrive/touchpoint-service.js"),n=chrome.runtime.getURL("content_scripts/gsuite/util.js");return Promise.all([import(e),import(t),import(n)]).then((e=>{u=e[0],c=e[1],m=e[2]}))})().then((()=>{m?.sendAnalyticsOncePerMonth("DCBrowserExt:Gdrive:OpenInExtension:Enable"),(e?.enableFteToolTip||e?.enableFteToolTipForListGridView)&&m?.sendAnalyticsOncePerMonth("DCBrowserExt:GdriveFTE:Enable"),(()=>{if(window?.document?.location?.pathname.includes("/u/"))return void(l.userId=window.document.location.pathname.split("/")[3]);const e=document.createElement("script");document.addEventListener("acrobat-auth-user-id",(t=>{l.userId=t?.detail?.authuser,e.remove()})),e.type="text/javascript",e.src=chrome.runtime.getURL("content_scripts/gdrive/get-auth-user.js"),document.head.appendChild(e)})(),s=chrome.runtime.getURL("browser/images/acrobat_dc_appicon_128.png"),(async()=>{const e=(new Date).getTime();let t={count:0,nextDate:e};t=(await chrome.storage.local.get(r))?.[r]||t;const n=l?.config?.fteConfig?.tooltip;((e,t)=>-1!==e?.resetDay&&t>e?.resetDay)(n,e)&&(t.count=0,t.nextDate=e),l.fteToolTip={...t},t={[r]:t},chrome.storage.local.set(t)})(),I(),(()=>{if(!l?.adobeCleanFontAdded){const e=chrome.runtime.getURL("browser/css/fonts/AdobeClean-Regular.otf"),t=new FontFace("AdobeClean-Regular",`url(${e})`);t.load().then((()=>{document.fonts.add(t)})),l.adobeCleanFontAdded=!0}})(),L(),G(),S(),x()})))}))},G=()=>{l?.config?.enableGDriveTripleDotMenuAnalytics&&(document.addEventListener("click",(e=>{c?.handleAnalyticsForTripleDotMenu(e),c?.handleAnalyticsForTopMenu(e)}),{signal:l?.eventControllerSignal}),document.addEventListener("contextmenu",(e=>{c?.handleAnalyticsForRightClickMenu(e)}),{signal:l?.eventControllerSignal}))},I=()=>{window.addEventListener("load",(()=>{setTimeout((()=>{l.pageLoaded=!0}),500)}))},B=e=>{if(!g&&(g=!0,e?.enableGDriveGridViewTouchPoint||e?.enableGDriveListViewTouchPoint)){const e=document.createElement("script");e.setAttribute("id","acrobat-response-interceptor"),e.src=chrome.runtime.getURL("content_scripts/gdrive/gdrive-inject.js"),e.onload=function(){this.remove()},(document.head||document.documentElement).appendChild(e)}};document.addEventListener("acrobat-addon-status-data",(e=>{setTimeout((()=>{(e=>{try{const t=JSON.parse(e?.detail?.responseData);if(!t)return void m?.sendAnalytics("DCBrowserExt:Gdrive:AddOn:ResponseMissing");if(l.addOnStatus={},!(Array.isArray(t?.items)&&t.items.length>0))return void m?.sendAnalytics("DCBrowserExt:Gdrive:AddOn:ResponseParsingFailed");if(l.addOnStatus.isAddOnInstalled=t.items.some((e=>e.id===a)),!l?.addOnStatus?.isAddOnInstalled)return void(l.addOnStatus.isAddOnDefault=!1);m?.sendAnalyticsOncePerMonth("DCBrowserExt:Gdrive:AddOn:Installed"),Array.isArray(t?.defaultAppIds)&&t.defaultAppIds.length>0?(l.addOnStatus.isAddOnDefault=t?.defaultAppIds?.includes(a),l?.addOnStatus?.isAddOnDefault&&m?.sendAnalyticsOncePerMonth("DCBrowserExt:Gdrive:AddOn:Default")):m?.sendAnalytics("DCBrowserExt:Gdrive:AddOn:DefaultStatusParsingFailed")}catch(e){m?.sendAnalytics("DCBrowserExt:Gdrive:AddOn:ResponseParsingFailed")}})(e)}),0)}),{signal:l?.eventControllerSignal}),chrome.runtime.onMessage.addListener((function(e){switch(e.content_op){case"acrobatGdriveFteStateUpdated":(e=>{l.fteToolTip={...l?.fteToolTip,...e?.fteState}})(e);break;case"acrobatGsuiteTouchPointsDisabled":d?.disconnect(),L()}})),(async()=>{"drive.google.com"===window?.document?.location?.host&&window.top===window.self&&0===window?.document?.location?.ancestorOrigins.length&&k()})()})();