/*************************************************************************
* ADOBE CONFIDENTIAL
* ___________________
*
*  Copyright 2015 Adobe Systems Incorporated
*  All Rights Reserved.
*
* NOTICE:  All information contained herein is, and remains
* the property of Adobe Systems Incorporated and its suppliers,
* if any.  The intellectual and technical concepts contained
* herein are proprietary to Adobe Systems Incorporated and its
* suppliers and are protected by all applicable intellectual property laws,
* including trade secret and or copyright laws.
* Dissemination of this information or reproduction of this material
* is strictly forbidden unless prior written permission is obtained
* from Adobe Systems Incorporated.
**************************************************************************/
import{dcLocalStorage as e,dcSessionStorage as t}from"../../../common/local-storage.js";import{dcTabStorage as a}from"../tab-storage.js";import{util as n}from"../content-util.js";import{signInUtil as r}from"./signInUtils.js";import{privateApi as i}from"../content-privateApi.js";import{COOLDOWN_FOR_LFT_PROMPT as s,OptionPageActions as o,LOCAL_FILE_PERMISSION_URL as c,LOCAL_FTE_WINDOW as d}from"../../../common/constant.js";import{indexedDBScript as l}from"../../../common/indexDB.js";import{loggingApi as m}from"../../../common/loggingApi.js";import{updateExtUserState as g,isNewUser as p}from"../../../common/util.js";import f from"./ResponseHeaders.js";import u from"./BookmarkUtils.js";import h from"./LruUtil.js";import{analytics as I,events as w}from"../../../common/analytics.js";import{fileUtil as b}from"./fileUtil.js";import{getDefaultViewershipStatusEvar as v}from"../../../content_scripts/gsuite/util.js";await e.init(),await t.init();const y=e.getItem("appLocale"),S="acrobatPromotionSource";let _=!1;!function(){let d,L,P,R,E,T,U,k,D,C,F,A,B,M,V,x,O,N,$,W,H,G,j,z,q="";const J=chrome.runtime.getURL("viewer.html"),Y=chrome.runtime.getURL("signInHandler.html"),K="file:",X=["https:","http:",K];let Z,Q;Z=new Promise((e=>Q=e)),ae({main_op:"chrome_viewer_opened",activeTabId:ne(document.location.search,"tabId")});const ee=e=>{if(!e)return!1;try{const t=new URL(e),a=t.protocol;let n=-1!==X.indexOf(a);return n=a===K?t.pathname.toLowerCase().endsWith(".pdf"):n,n}catch(e){return!1}};function te(e){const t=a.getItem("search");return new URLSearchParams(t).get(e)}function ae(e,t){return M?(V=V||1,e.tabId=V,e.mimeHandled=!0,chrome.runtime.sendMessage(e,t)):chrome.runtime.sendMessage(e,t)}function ne(e,t){return new URLSearchParams(e).get(t)||""}function re(){if(R=ne(document.location.search,"pdfurl"),G=ne(document.location.search,"tabId"),j=ne(document.location.search,"aw"),!ee(R))return void(E=!1);!function(){const e=new URLSearchParams(document.location.search),n=t.getItem("rtParams");if(n){const a=n.split(",").map((t=>e.has(t)?`&${t}=${e.get(t)}`:null)).join("")||"";t.setItem("payPalUrl",a),t.removeItem("rtParams")}e.has("dialog!dropin")&&a.setItem("dialog!dropin",e.get("dialog!dropin")),e.has("load!dropin")&&a.setItem("load!dropin",e.get("load!dropin"))}();const e=a.getItem("search");(!e||ne(e,"pdfurl")!==R||e.length<document.location.search)&&a.setItem("search",document.location.search),P=ne(document.location.search,"pdffilename")||ne(e,"pdffilename")||Ee(R),document.title=P;const n="/"+R+location.hash;history.replaceState({},P,n)}function ie(t){e.setItem(`reloadurl-${t.id}`,R);const a=new URL(R);if(function(e){e?.searchParams?.has(S)&&m.info({message:"reloadInNativeViewer",source:e.searchParams.get(S)})}(a),Je(a)){const e=a?.searchParams?.get("id");window.location.href=`https://drive.google.com/file/d/${e}`}else window.location.href=R}function se(e=!1){if(M)try{e||ae({main_op:"viewer-type",viewer:"mime-native"}),setTimeout((()=>{i.reloadWithNativeViewer({contentLength:parseInt(d)||0})}),100)}catch(e){ce("DCBrowserExt:Viewer:FallbackToNative:Failed")}else try{setTimeout((()=>{chrome.tabs.getCurrent(ie)}),500)}catch(e){ce("DCBrowserExt:Viewer:FallbackToNative:Failed")}}const oe=t=>{try{const a=new URL(e.getItem("cdnUrl")),n=[/^https:\/\/([a-zA-Z\d-]+\.){0,}(adobe|acrobat)\.com(:[0-9]*)?$/];return t===a.origin&&!!n.find((e=>e.test(t)))}catch(e){return!1}};function ce(e){const t={main_op:"analytics"};t.analytics=[[e]],ae(t)}function de(){return qe(R)?`${J}?pdfurl=${encodeURIComponent(R)}&pdffilename=${encodeURIComponent(document.title)}`:R}function le(){let e,t=J;return M?(e="?mimePdfUrl="+encodeURIComponent(R),t=Y):(e=a.getItem("search"),e||(e="?pdfurl="+encodeURIComponent(R))),new URL(t+e)}const me=["AdobeID","openid","DCAPI","sign_user_read","sign_user_write","sign_user_login","sign_library_read","sign_library_write","agreement_send","agreement_read","agreement_write","ab.manage","additional_info.account_type","sao.ACOM_ESIGN_TRIAL","widget_read","widget_write","workflow_read","workflow_write"];function ge(t={}){if(e.getItem("csi")){const e=de(),a={...t,pdfUrl:e};return void r.cdnSignIn(a)}const a=le(),i=e.getItem("cdnUrl"),s=t.sign_up?1:0,o=n.generateStateCSRF(),c=e.getItem("enableCSRF"),d=JSON.stringify({touchp:t.touchpoint||"",signIn:!0,...c&&{state:o}}),l=e.getItem("theme")||"auto",m=`${i}?la=true&locale=${y||e.getItem("locale")}&theme=${l}&ru=${encodeURIComponent(a.href)}&rp=${d}&su=${s}#/susi`;chrome.tabs.update({url:m,active:!0})}function pe(){let e;e=M?le().href:window.location.href,r.sign_out(e)}function fe(t={}){if(e.getItem("csi")){const e={...t,pdfUrl:R};return void r.cdnSignIn(e)}let n=new URL(Y);const i=t.idp_token;return n.searchParams.append("socialSignIn","true"),n.searchParams.append("mimePdfUrl",encodeURIComponent(R)),a.setItem("idp_token",i),n.href}function ue(e={}){M?chrome.tabs.update({url:fe(e),active:!0}):r.socialSignIn(e,le(),R)}function he(t={}){if(e.getItem("csi")){try{const e=new URL(JSON.parse(t.url));delete t.url;const a={...t,pdfUrl:de()},n=r.getCDNSignURL(a);e.searchParams.append("redirect_uri",n),chrome.tabs.update({url:e.href,active:!0})}catch(e){chrome.tabs.update({url:R})}return}const i=t.application||"google",s=e.getItem("viewerImsClientIdSocial"),o=e.getItem("imsURL"),c=n.uuid(),d=le();d.hash=d.hash+"signIn=true";const l=new URL(o+"/ims/authorize/v1"),m={ac:n.getAppCode(),csrf:c};a.setItem("csrf",c),l.searchParams.append("response_type","token"),l.searchParams.append("idp_flow","social.deep_link.web"),l.searchParams.append("client_id",s),l.searchParams.append("provider_id",i),l.searchParams.append("redirect_uri",d),l.searchParams.append("scope",me.join(",")),l.searchParams.append("locale",y||e.getItem("locale")),l.searchParams.append("state",JSON.stringify(m)),l.searchParams.append("xApiClientId",s),l.searchParams.append("xApiClientLocation ",i),chrome.tabs.update({url:l.href,active:!0})}const Ie={isSharePointURL:!1,isSharePointFeatureEnabled:!1,isFrictionlessEnabled:!0,featureFlags:[],isFillAndSignRegisteryEnabled:!1};class we{constructor(e){this.iframeElement=void 0,this.parentDiv=e}createIframe=t=>{const a=window.document,n=(e.getItem("cdnUrl"),a.createElement("iframe"));n.setAttribute("src",t),n.setAttribute("id","dc-view-frame"),n.setAttribute("allowfullscreen","allowfullscreen"),n.setAttribute("allow","clipboard-read; clipboard-write; local-fonts; payment;"),n.style.width="100vw",n.style.height="100vh",n.style.border="none",n.style.overflow="hidden",this.parentDiv.appendChild(n),m.info({message:"Viewer Iframe created"}),this.iframeElement=a.getElementById("dc-view-frame")};_sendMessage=(e,t)=>{this.iframeElement&&oe(t)&&function(e){let t=Date.now();return new Promise((function a(n,r){T&&(E||M)?n(E||M):e&&Date.now()-t>=e?r(new Error("timeout")):setTimeout(a.bind(this,n,r),30)}))}(1e6).then((a=>a&&this.iframeElement.contentWindow.postMessage(e,t)))};sendStartupConfigs=(e,a)=>{this._sendMessage({type:"nativeConfigs",nativeConfigs:Ie,extUrl:encodeURI(e),returnParamsUrl:t.getItem("payPalUrl"),isInstallTypeUpsell:_},a)};sendFileMetaData=(e,t,a,n,r,i,s,o)=>{this._sendMessage({fileUrl:r,fileName:i,fileSize:a,acceptRanges:n,handShakeTime:t,type:e,isFrictionlessEnabled:Ie.isFrictionlessEnabled,isReloadOrBackForward:o,isMimeHandled:M},s)};sendSubmitFormResponse=(e,t)=>{this._sendMessage({type:"submitForm",response:e},t)};sendRecentUrl=async(e,t,a,n=!1)=>{await chrome.extension.isAllowedFileSchemeAccess()||(t=t?.filter((e=>!e.url.startsWith("file://")))),this._sendMessage({type:"RecentUrls",permission:e,showOverlay:n,recentUrls:t},a)};sendProgress=(e,t,a,n)=>{this._sendMessage({total:t,loaded:a,type:e},n)};sendInitialBuffer=(e,t,a,n,r)=>{this._sendMessage({type:e,downLoadstartTime:t,downLoadEndTime:a,buffer:n},r)};sendBufferRanges=(e,t,a,n)=>{this._sendMessage({type:e,range:t,buffer:a},n)};preview=(e,t,n,r,i,s,o)=>{const c="true"===a.getItem("bufferFromIndexedDB");a.removeItem("bufferFromIndexedDB"),this._sendMessage({fileSize:n,type:e,fileBuffer:t,fileName:r,downLoadstartTime:i,downLoadEndTime:s,fromIndexedDB:c},o)};openInAcrobatResponse=(e,t,a)=>{this._sendMessage({type:e,res:t},a)};postLog=(e,t,a,n,r)=>{this._sendMessage({type:e,reqId:t,message:a,error:n},r)};sendCertificateValidationResponse=(e,t)=>{this._sendMessage({type:"certificateValidationResponse",response:e},t)}}function be(t,a){try{F=void 0!==F?F:"false"!==e.getItem("logAnalytics")&&"false"!==e.getItem("ANALYTICS_OPT_IN_ADMIN"),F&&(D&&L?D.postLog("log",C,t,a,L.origin):setTimeout((()=>{D&&L&&D.postLog("log",C,t,a,L.origin)}),500))}catch(e){}}function ve(){let e;return e=M?R:window.location.href,e}function ye(){const t=ve(),n=(t.split("#")||[]).pop();if(n.indexOf("access_token=")>-1)try{const i=new URLSearchParams(n).get("access_token"),{client_id:s}=JSON.parse(window.atob(i.split(".")[1]))||{},o=e.getItem("viewerImsClientId");if([o,e.getItem("viewerImsClientIdSocial")].includes(s)){const e=a.getItem("csrf");a.removeItem("csrf");const n=r.parseCSRF(new URL(t));(!e||!n||n!==e)&&(ce("DCBrowserExt:Viewer:User:Error:NonMatchingCsrfToken:FailedToLogin"),pe())}}catch{}}function Se(t,a,n,r,i){i&&t.forEach((e=>{n.has(e)&&a.searchParams.append(e,n.get(e))})),r&&t.forEach((t=>{""!==e.getItem(t)&&a.searchParams.append(t,e.getItem(t))}))}function _e(e){return e?.toLowerCase()?.startsWith("gmail")?"gmail":e?.toLowerCase()?.startsWith("googledrive")?"googleDrive":""}const Le=()=>{try{let i;i=M?new URLSearchParams(new URL(R).search):new URLSearchParams(window.location.search);const s=function(t){const a=e.getItem("cdnUrl");try{if("prod"===e.getItem("env"))return a;const n=t.get("ephemeralUrl");if(!n)return a;const r=new URL(n);return"https:"===r.protocol&&["stage.acrobat.adobe.com","dev.acrobat.adobe.com"].includes(r.hostname)&&r.pathname.startsWith("/ephemeral/dc-chrome-extension/")?n:a}catch(e){return console.error("Error validating ephemeral URL:",e?.message||"Unknown error"),a}}(i),o=new URL(s);if(!oe(o.origin))return be("Invalid CDN URL detected","Invalid Origin"),void se();L||(L=o);let c=e.getItem("viewer-locale");c||(c=e.getItem("locale"));const d="false"!==e.getItem("logAnalytics"),l="false"!==e.getItem("ANALYTICS_OPT_IN_ADMIN"),m=d&&l?"true":l?"optinOff":"gpoOff",g="true"===e.getItem("betaOptOut");o.searchParams.append("locale",y||c),o.searchParams.append("logAnalytics",m),o.searchParams.append("callingApp",chrome.runtime.id),o.searchParams.append("betaOptOut",g),o.searchParams.append("lfa",e.getItem("isAllowedLocalFileAccess")||"false"),o.searchParams.append("enableCaretMode",N),t.getItem("signInTp")&&o.searchParams.append("touchp",t.getItem("signInTp")),o.searchParams.append("rvu",e.getItem("userState")?.rvu??null);const f=e.getItem("installType")||"update",u=e.getItem("installSource");o.searchParams.append("version",`${chrome.runtime.getManifest().version}:${f}`),o.searchParams.append("installSource",u),o.searchParams.append("storage",JSON.stringify(e.getItem("viewerStorage")||{})),o.searchParams.append("fgContextVars",JSON.stringify(function(){const t="true"===e.getItem("betaOptOut"),a="true"===e.getItem("adobeInternal"),r=e.getItem("pdfViewer");let i;return i=r?"true"===r?"enabled":"disabled":"neverEnabled",{extVersion:chrome.runtime.getManifest().version,extId:chrome.runtime.id,installType:e.getItem("installType"),installVersion:e.getItem("installVersion"),adbInt:!t&&a,extbrowser:n.isEdge()?"edge":"chrome",viewerStatus:i}}())),o.searchParams.append("tabId",G),o.searchParams.append("adbIntTTL",e.getItem("adobeInternalTTL")),o.searchParams.append("adbExtTTL",e.getItem("adobeExternalTTL")),o.searchParams.append("fglc",e.getItem("fgLastCallTimestamp")),"false"===e.getItem("staticFteCoachmarkShown")&&o.searchParams.append("showFTECoachmark","true"),"true"!==te("googlePrint")&&!0!==x||"false"===a.getItem("googleAppsPrint")||o.searchParams.append("googleAppsPrint","true"),o.searchParams.append("sdp",e.getItem("sdp")?"1":"0"),o.searchParams.append("sds",e.getItem("sds")?"1":"0"),o.searchParams.append("lf",e.getItem("lf")?"1":"0");const h=H.read(R);h&&(delete h.filename,delete h.lastVisited,o.searchParams.append("docState",JSON.stringify(h))),o.searchParams.append("nu",p()),o.searchParams.append("rs",e.getItem("rs")?"1":"0"),o.searchParams.append("nm",e.getItem("supportNightMode")?"1":"0"),o.searchParams.append("dpt",e.getItem("isDarkPageThemeEnabled")?"1":"0"),o.searchParams.append("action",e.getItem("pdfMarkerAction")),e.removeItem("pdfMarkerAction"),o.searchParams.append("adminDisableGenAI","true"===e.getItem("DISABLE_GENAI_BY_ADMIN")?"1":"0");const I=["dropin!","provider!","app!","forceDisableGenAI"],w=["analytics","logToConsole","enableLogging","frictionless","sessionId","linearization","ev","ao"],b=["rrv","fgRearch","isDeskTop","isAcrobat","theme","defaultOwnerShipExperiment","sessionId","ev","ao","ip","rate","genAI","mv","pi","ks","edd","tpt","lft","fsu","dcs","egal","ots","egaf","gga","pnb","subv2","s3d","ips","ripe"];let v=a.getItem("signinTouchPointData");v=JSON.parse(v||"{}"),v&&"object"==typeof v&&Object.keys(v).length&&(o.searchParams.append("tp",v.touchpoint),o.searchParams.append("acmt",v.allowCommentsInShare?"1":"0")),a.removeItem("signinTouchPointData");e.getItem("env");const _=new URLSearchParams(new URL(R).search).get(S),P=_e(_);if(_&&P){const t=("true"===e.getItem(`${P}-pdf-default-viewership`)).toString();o.searchParams.append("aDFrSfce",t),o.searchParams.append("sfceId",P),o.searchParams.append("sfceDVFe","true"===e.getItem(`${P}-pdf-dv-feature-enablement-status`)),o.searchParams.append("aDFrSfceUsrDsbl","true"===e.getItem(`${P}-pdf-default-viewership-user-disabled`))}r=o,["dialog!dropin","load!dropin"].forEach((e=>{""!==(a.getItem(e)||"")&&r.searchParams.append(e,a.getItem(e))})),Se(w,o,i,!1,!0),Se(b,o,i,!0,!1);let E=o.href;I.forEach((e=>{i.forEach(((t,a)=>{a.startsWith(e)&&(E=E+"&"+a+"="+t)}))})),""===t.getItem("payPalUrl")||""===a.getItem("dialog!dropin")&&""===a.getItem("load!dropin")||(E+=t.getItem("payPalUrl"));const T=a.getItem("access_token");return a.removeItem("access_token"),e.setItem("lastPdfOpenTimestamp",(new Date).getTime()),`${E}${T?`/#${T}`:""}`}catch(e){ce("DCBrowserExt:Viewer:Iframe:Creation:Failed"),se()}var r},Pe=(a,n,r="localStorage")=>{if(n){const i="localStorage"===r?e.getItem(a):t.getItem(a);let s;i&&i.tabsInfo?(s=i.tabsInfo,s.includes(n)||s.push(n)):s=[n],"localStorage"===r?e.setItem(a,{tabsInfo:s}):t.setItem(a,{tabsInfo:s})}},Re=()=>{try{!function(){try{let e=ve();e&&e.indexOf("#")>-1&&(r.saveAccessToken(e),r.signInAnalyticsLogging(e),r.checkSignInFromEditVerbPaywall(e),e=e.split("#")[0],M?R=e:(window.location.hash=e,history.replaceState(null,document.title,e)))}catch(e){}}(),M&&(G=V);const a=window.document.getElementById("Adobe-dc-view");M||(d=te("clen")||-1),D=new we(a);const n=Le();D.createIframe(n),g(),window.addEventListener("message",(a=>{!a.data||!oe(a.origin)||U||"hsready"!==a.data.type&&"ready"!==a.data.type||(U=!0,k=(new Date).getTime(),C=a.data.requestId,"on"===a.data.killSwitch?(ce("DCBrowserExt:Viewer:KillSwitch:Turned:On"),e.setItem("pdfViewer","false"),i.setViewerState("disabled"),e.setItem("killSwitch","on"),M?se(!0):setTimeout((()=>{window.location.href=R}),200)):e.getItem("killSwitch")&&(ce("DCBrowserExt:Viewer:KillSwitch:Turned:Off"),e.removeItem("killSwitch")),t.getItem("signInTp")&&t.removeItem("signInTp"))}))}catch(e){be("Error create Iframe",e)}};function Ee(e){if(P)return P;let t=e;try{const a=e.split("?")[0].split("/").filter((e=>e.length>0)),n=a.length>0?a[a.length-1]:"untitled";t=n;const r=n.length-4;(n.length<4||n.toLowerCase().indexOf(".pdf")!==r)&&(t+=".pdf")}catch(e){be("Error in getFileNameFromURL",e)}return t}function Te(e,t){return function(a){if(this.readyState==this.HEADERS_RECEIVED){if(!function(e,t){const a=e.getResponseHeader("content-type"),n=qe(t),r=e.getResponseHeader("content-disposition");if(a){const e=a.toLowerCase().split(";",1)[0].trim();if(!n&&r&&/^\s*attachment[;]?/i.test(r))return!1;if("application/pdf"===e)return!0;if("application/octet-stream"===e&&r&&/\.pdf(["']|$)/i.test(r))return!0}return!1}(e,t))return be("Fall back to native - not pdf from headers"),se();if(E=!0,"true"===j){const e=this.getResponseHeader("accept-ranges"),a=this.getResponseHeader("content-length");e&&"bytes"===e&&a&&Number(a)>0&&ae({main_op:"setupWorkerOffscreen",pdfURL:t,pdfSize:+a,acceptRanges:!0,tabId:G})}}}}function Ue(e,t){let a=!1;return function(n){n.lengthComputable&&(d=n.total,e.sendProgress("progress",n.total,n.loaded,t),a||(!function(e){const t=H.read(R)||{},a={main_op:"getFileSize",fileSize:e,tabId:G,docLastOpenState:t,target:"offscreen"};chrome.runtime.sendMessage(a)}(d),a=!0))}}function ke(e,t){"PDF"===function(e){if(e)try{let t=new URL(e).pathname;return t.substr(t.lastIndexOf(".")+1).toUpperCase()}catch(e){return""}return""}(e)&&(E=!0);const a=new XMLHttpRequest;a.open("GET",e),a.responseType="arraybuffer",a.onreadystatechange=function(){4===a.readyState&&(200!==a.status&&0!=a.status||(t({buffer:a.response,mimeType:a.getResponseHeader("content-type")}),Ce(a.response)))},a.send(null)}async function De(){try{const t=a.getItem("bufferTabId");if(t){const e=await l.getDataFromIndexedDB(t);if(e&&e.fileBuffer)return a.setItem("bufferFromIndexedDB",!0),E=!0,{buffer:e.fileBuffer}}else{const t=e.getItem("tabIdMap");if(t){const n=(M?await chrome.tabs.query({active:!0,currentWindow:!0}):[await chrome.tabs.getCurrent()])[0];if(n&&t[n.id]){a.setItem("bufferTabId",t[n.id]);const r=await l.getDataFromIndexedDB(t[n.id]);if(Object.keys(t).length>1?(delete t[n.id],e.setItem("tabIdMap",t)):e.removeItem("tabIdMap"),r&&r.fileBuffer)return a.setItem("bufferFromIndexedDB",!0),E=!0,{buffer:r.fileBuffer}}}}}catch(e){}return a.setItem("bufferFromIndexedDB",!1),{}}function Ce(e){const t=H.read(R)||{},a=new Blob([e],{type:"application/pdf"}),n={main_op:"getFileBuffer",fileBufferBlob:URL.createObjectURL(a),tabId:G,docLastOpenState:t,target:"offscreen"};chrome.runtime.sendMessage(n)}function Fe(e,t){ce(`DCBrowserExt:Viewer:SignIn:AdobeYolo:${e}:clicked`),chrome.tabs.query({active:!0,currentWindow:!0},(function(e){var t=e[0]&&e[0].id;Pe("adobeYoloTabsInfo",t,"sessionStorage")})),ae({main_op:"launchJumpUrl",details:{source:e,userGuid:t}},(t=>{D._sendMessage({type:"adobeYoloJumpResponse",response:t,source:e},L.origin)}))}function Ae(e,t,...a){M?l.storeBufferAndCall(e,t,V,...a):chrome.tabs.getCurrent((function(n){l.storeBufferAndCall(e,t,n.id,...a)}))}function Be(e){D._sendMessage({type:"redirectToAcrobatWeb",response:e},L.origin)}function Me(){M?chrome.tabs.reload(V):chrome.tabs.getCurrent((e=>{chrome.tabs.reload(e.id)}))}function Ve(r,d){switch(d.data.main_op){case"open_in_acrobat":case"fillsign":!async function(t,a){const r={main_op:"open_in_acrobat"};if("fillsign"===a.data.main_op&&(r.paramName="FillnSign"),r.url=a.data.url,r.click_context="pdfviewer",r.timeStamp=Date.now(),r.filename=a.data&&a.data.filename,a.data.fileBuffer){const e=new Blob([a.data.fileBuffer],{type:"application/pdf"});r.dataURL=URL.createObjectURL(e)}if(O=function(e){"fillsign"===a.data.main_op?t.openInAcrobatResponse("FILLSIGN_IN_DESKTOP_APP",e,a.origin):t.openInAcrobatResponse("OPEN_IN_DESKTOP_APP",e,a.origin),be(`Open In Acrobat - (${a.data.main_op}) response- ${e}`)},e.getItem("isSharepointFeatureEnabled"))if(Ie.isSharePointURL)r.workflow_name="SharePoint",r.isSharePointURL=!0,ae(r,O);else{const e=await n.checkForSharePointURL(r.url);r.isSharePointURL=e,e&&(r.workflow_name="SharePoint"),ae(r,O)}else ae(r,O)}(r,d);break;case"complete_conversion":ce("DCBrowserExt:Viewer:Verbs:Conversion:Redirection"),function(e){const t={};t.main_op=e.data.main_op,t.conversion_url=decodeURIComponent(e.data.conversion_url),t.timeStamp=Date.now(),ae(t)}(d);break;case"updateLocale":ce("DCBrowserExt:Viewer:User:Locale:Updated"),e.setItem("viewer-locale",d.data.locale),ae({main_op:"localeChange",locale:d.data.locale}),chrome.tabs.reload();break;case"setInitialLocale":let p=!1;e.getItem("viewer-locale")||(p=!0,e.setItem("viewer-locale",d.data.locale),ce("DCBrowserExt:Viewer:User:Locale:Initial")),d.data.reloadReq&&p&&chrome.tabs.reload();break;case"error-sign-in":!function(e){const t=n.uuid();a.setItem("csrf",t);const r=new URL(e),i=le();i.hash=i.hash+`state=${t}&signInError=true`,r.searchParams.set("redirect_uri",i),chrome.tabs.update({url:r.href,active:!0})}(d.data.url);break;case"deleteViewerLocale":e.getItem("viewer-locale")&&(e.removeItem("viewer-locale"),chrome.tabs.reload());break;case"signin":ce("DCBrowserExt:Viewer:Ims:Sign:In"),a.setItem("signInSource",d.data.source),a.setItem("signinTouchPointData",JSON.stringify({touchpoint:d.data.tp,allowCommentsInShare:d.data.allowCommentsInShare})),ce(`DCBrowserExt:Viewer:Ims:Sign:In:${d.data.source}`),Ae(d.data.fileBuffer,ge,d.data);break;case"googleSignIn":ce("DCBrowserExt:Viewer:Ims:Sign:In"),ce(`DCBrowserExt:Viewer:Ims:Sign:In:${d.data.source}`),a.setItem("signInSource",d.data.source),Ae(d.data.fileBuffer,he,d.data);break;case"signup":ce("DCBrowserExt:Viewer:Ims:Sign:Up"),a.setItem("signUpSource",d.data.source),ce(`DCBrowserExt:Viewer:Ims:Sign:Up:${d.data.source}`),Ae(d.data.fileBuffer,ge,d.data);break;case"reload_viewer":chrome.tabs.reload();break;case"reload_current_tab":Me();case"upsell_event":!function(e){if(e&&e.url){const a=new URL(decodeURIComponent(e.url));e.returnUrlParams&&t.setItem("rtParams",e.returnUrlParams.toString()),"_blank"===e.target?chrome.tabs.create({url:a.href,active:!0}):chrome.tabs.update({url:a.href,active:!0})}}(d.data);break;case"upsell_remove_urlParams":t.removeItem("rtParams"),t.removeItem("payPalUrl"),a.removeItem("dialog!dropin"),a.removeItem("load!dropin");break;case"fetchLocalRecents":const f=new URL(e.getItem("cdnUrl")).origin;if(d.data.fetchRecents){const e=d.data.showOverlay;!async function(e,t,a=!1){const n=H.getAllItems();e.sendRecentUrl(!0,n,t,a)}(D,f,e)}else D.sendRecentUrl(!0,null,f);break;case"socialSignIn":ce("DCBrowserExt:Viewer:Ims:Sign:In"),ce(`DCBrowserExt:Viewer:Ims:Sign:In:${d.data.source}`),a.setItem("signInSource",d.data.source),Ae(d.data.fileBuffer,ue,d.data);break;case"openRecentFileLink":const h={};h.main_op=d.data.main_op,h.recent_file_url=decodeURIComponent(d.data.recent_file_url),h.file_name=d.data.file_name,ae(h);break;case"updateCurrentURL":!async function(e){const{redirectURL:t,copyToClipboard:a}=e;if(a)try{await navigator.clipboard.writeText(a)}catch(e){}const n=M?V:(await chrome.tabs.getCurrent())?.id;chrome.tabs.update(n,{url:t})}(d.data);break;case"saveFileBufferAndReload":case"saveFileBufferAndReload":Ae(d.data.fileBuffer,Me);break;case"userSubscriptionData":if(M){const e={};e.eventType=d.data.main_op,e.userSubscriptionData=d.data.userSubscriptionData,e.data=d.data,e.main_op=d.data.main_op;ae(e,(function(e){e&&"showUninstallPopUp"===e.main_op&&D._sendMessage({type:"showUninstallPopUp"},L.origin)}))}break;case"uninstall":M&&ae({main_op:"uninstall",defaultUrl:R});break;case"submit_form":fetch(d.data.resource,d.data.options).then((e=>{D.sendSubmitFormResponse(e.ok,d.origin)})).catch((()=>{D.sendSubmitFormResponse(!1,d.origin)}));break;case"ownerShipExperimentShown":e.removeItem("defaultOwnerShipExperiment");break;case"openAcrobatOptions":chrome.runtime.openOptionsPage(),ce(`DCBrowserExt:Viewer:ManagePref:clicked:${d.data.source}`);break;case"openExtensionSettings":if("pinToolbar"===d.data.action)chrome.tabs.query({active:!0,currentWindow:!0},(function(e){const t=e[0];n.openExtensionSettingsInWindow({tab:t,action:d.data.action})}));else{const t=e.getItem("openSettingsInWindow");t?chrome.tabs.query({active:!0,currentWindow:!0},(function(t){const a=t[0];e.setItem("lastOpenTabId",a.id),n.openExtensionSettingsInWindow({tab:a,action:d.data.action})})):chrome.tabs.create({url:c,active:!0}),I.event(w.LOCAL_FILE_ACCESS_TOUCHPOINT_SETTINGS_OPENED,{VARIANT:t?"InWindow":"InTab"}),e.setItem("LocalFileAccessTouchpointsFromViewer",!0),setTimeout((()=>{e.removeItem("LocalFileAccessTouchpointsFromViewer")}),s),ae({main_op:"triggerBufferSave"})}break;case"encryptedWriteFile":({secureString:q}=d.data),$e(document.title);break;case"launchJump":Ae(d.data.fileBuffer,Fe,d.data.source,d.data.userGuid);break;case"saveAsEvent":!async function(e){try{if(ce("DCBrowserExt:Viewer:SaveToMyComputer:"+(W?"fileHandlerExist":"fileHandlerNotExist")),W)z=!1;else{const t={suggestedName:`${e.fileName}.pdf`,types:[{description:"PDF file",accept:{"application/pdf":[".pdf"]}}]};W=await window.showSaveFilePicker(t),z=!0,$e(W?.name)}D._sendMessage({type:"newSaveToLocalResponse",newAsset:z,updatedFileName:W?.name},L.origin)}catch(e){W=null,be("Save As Handler Error",e),D._sendMessage({type:"newSaveToLocalResponse",error:e},L.origin)}}(d.data);break;case"downloadFile":!async function(e){let t=null;try{let a=e.fileUrl;const n=e.fileName||P||"untitled";if(!a){const n=new Blob([e.fileBuffer],{type:"application/pdf"});t=URL.createObjectURL(n),a=t}await chrome.downloads.download({url:a,conflictAction:"uniquify",saveAs:!0,filename:`${n}.pdf`})}catch(e){be("downloadFile error",e),D._sendMessage({type:"downloadFileError"},L.origin)}finally{t&&URL.revokeObjectURL(t)}}(d.data);break;case"rememberSaveLocationPreference":!function(t){let a="";t.cloudStorage&&!e.getItem("selectedSaveLocationPreference")?a="PreferenceMigrationSuccess":t.cloudStorage||(a="SaveDialogRememberMe");a&&ce(`DCBrowserExt:Viewer:ChangeSaveLocationPreference:${a}`);(!t.cloudStorage||t.cloudStorage&&!e.getItem("selectedSaveLocationPreference"))&&(e.setItem("saveLocation",t.saveLocation),e.setItem("selectedSaveLocationPreference",!0),ae({panel_op:"options_page",requestType:o.OPTIONS_UPDATE_TOGGLE,toggleId:"saveLocationPreferenceTitle",toggleVal:t.saveLocation}))}(d.data);break;case"appRenderingDone":nt();break;case"saveFileBuffer":Ae(d.data.fileBuffer);break;case"deleteFileBuffer":const b=a.getItem("bufferTabId");b&&l.deleteDataFromIndexedDB(b),a.removeItem("bufferTabId");case"appRenderingDone":nt();break;case"writeToLocalSavedFile":!async function(e){try{const t=await W.createWritable();await t.write(e.fileBuffer),await t.close(),D._sendMessage({type:"newSaveToLocalResponse",newAsset:z,updatedFileName:W?.name,isFileWriteStage:!0},L.origin)}catch(e){W=null,be("Write to Local File Error",e),D._sendMessage({type:"newSaveToLocalResponse",error:e,isFileWriteStage:!0},L.origin)}}(d.data);break;case"bookmarkWeb":u(d.data.url,Be,ce);break;case"updateDocumentViewState":!function(e){const{documentViewState:t}=e;H.writeAndSyncWithHistory(R,t)}(d.data);break;case"validateEdgeCertificateForDigitalSignature":i.validateCertificate(d.data).then((e=>D.sendCertificateValidationResponse(e,d.origin)));break;case"documentViewThemeChange":!function(t){e.getItem("theme")!==t.data&&(e.setItem("theme",t.theme),ae({panel_op:"options_page",requestType:o.OPTIONS_UPDATE_TOGGLE,toggleId:"appearancePrefTitle",toggleVal:t.theme}));e.getItem("isDarkPageThemeEnabled")!==t.isDarkPageThemeEnabled&&e.setItem("isDarkPageThemeEnabled",t.isDarkPageThemeEnabled)}(d.data);break;case"enableGenAIFeaturesToggledFromViewer":g=d.data,e.getItem("egaf")!==g.isEnabled&&(e.setItem("egaf",g.isEnabled.toString()),ae({panel_op:"options_page",requestType:o.OPTIONS_UPDATE_TOGGLE,toggleId:"enableGenAIFeaturesTitle",toggleVal:g.isEnabled}));break;case"genAIEligible":!function(t){e.setItem("genAIEligible",t?.isEligible?.toString()),Q(t?.isEligible||!1)}(d.data);break;case"rrvLayerRemoved":chrome.runtime.sendMessage({main_op:"rrvLayerRemoved",tabId:d.data.tabId,target:"offscreen"});break;case"setFloodgateResponseFromViewer":chrome.runtime.sendMessage({main_op:"handleViewerFloodgateResponse",fgResponse:d.data.fgResponse});break;case"getSignedInCachedffResponse":m=d.data.userId,D._sendMessage({type:"signedInCachedffResponse",ffResponse:e.getItem(`ffResponse_${m}`)||"{}"},L.origin);break;case"changeDefaultViewershipForSurface":chrome.runtime.sendMessage({...d.data})}var m,g}function xe(e){try{const t=new TextDecoder("utf-8").decode(e.buffer);let a=!1;-1!=t.indexOf("Linearized 1")?a=!0:-1!=t.indexOf("Linearized")&&ce("DCBrowserExt:Viewer:Linearization:Linearized:Version:Other"),D._sendMessage({type:"Linearization",linearized:a},L.origin)}catch(e){ce("DCBrowserExt:Viewer:Linearization:Linearized:Detection:Failed"),be("Linearization Detection failed",e)}}function Oe(t,a,n,r){n.then((n=>{const i=n.downLoadEndTime,s=n.buffer;n.buffer.byteLength;t.preview("preview",s,d,P,r,i,a.origin),D._sendMessage({type:"NavigationStartTime",time:window.performance&&window.performance.timing&&window.performance.timing.navigationStart},L.origin),!0===e.getItem("isSaveLocationPrefEnabled")&&D._sendMessage({type:"changeSaveLocationPreference",saveLocation:e.getItem("saveLocation"),onLoad:!0},L.origin)})).catch((e=>(ce("DCBrowserExt:Viewer:Error:FallbackToNative:FileDownload:Failed"),se()))).finally((()=>{e.removeItem("sessionStarted")}))}class Ne{constructor(){this.request={main_op:"analytics"}}analytics=e=>{this.request.analytics||(this.request.analytics=[]),this.request.analytics.push([e])};sendAnalytics=()=>{ae(this.request)}}function $e(e){e&&(document.title=e+q)}const We=(t,a,n)=>{const r=n?"viewerStorage":"viewerStorageAsync",i=e.getItem(r)||{};i[t]=a,e.setItem(r,i)},He=t=>{const a=e.getItem("viewerStorage")||{},n=e.getItem("viewerStorageAsync")||{};delete a[t],delete n[t],e.setItem("viewerStorage",a),e.setItem("viewerStorageAsync",n)};function Ge(t,n,r,i){return s=>{try{if(s.data&&s.origin&&oe(s.origin)&&(e=>{try{return e&&e.source&&e.source.top.location.origin==="chrome-extension://"+chrome.runtime.id}catch(e){return!1}})(s)){if(s.data.main_op)return Ve(t,s);switch(s.data.type){case"ready":if(M?async function(t,n,r,i){let s=new Ne;T=!0;const o=R;document.title=P;const c=$.getHeaderValue("accept-ranges"),l=!a.getItem("bufferTabId")&&c&&"bytes"===c.toLowerCase()?"true":"false";et(),t.sendFileMetaData("metadata",k,d,l,o,P,n.origin,!1),Ze(),r&&r.then((e=>{t.sendInitialBuffer("initialBuffer",e.startTime,e.endTime,e.buffer,n.origin),xe(e)})).catch((e=>{t.sendInitialBuffer("initialBuffer",0,0,-1,n.origin),s.analytics("DCBrowserExt:Viewer:Error:Linearization:InitialBufiled")})),e.removeItem("isReload"),e.removeItem("isBackForward");const m=window.performance&&window.performance.timing&&window.performance.timing.navigationStart,g=De();(await g).buffer?Oe(t,n,g,m):(fetch(i.streamUrl).then((e=>{let a=0;return new Response(new ReadableStream({start(r){const i=e.body.getReader();!function e(){i.read().then((({done:i,value:s})=>{i?r.close():(a+=s.byteLength,t.sendProgress("progress",d,a,n.origin),r.enqueue(s),e())})).catch((e=>{r.error(e)}))}()}}))})).then((e=>e.arrayBuffer())).then((a=>{d=a.byteLength,Ce(a),t.preview("preview",a,a.byteLength,P,m,(new Date).getTime(),n.origin),D._sendMessage({type:"NavigationStartTime",time:window.performance&&window.performance.timing&&window.performance.timing.navigationStart},n.origin),!0===e.getItem("isSaveLocationPrefEnabled")&&D._sendMessage({type:"changeSaveLocationPreference",saveLocation:e.getItem("saveLocation"),onLoad:!0},n.origin)})).catch((e=>(s.analytics("DCBrowserExt:Viewer:Error:FallbackToNative:FileDownload:Failed"),se()))),s.sendAnalytics()),be("Viewer loaded")}(t,s,r,n):function(e,t,n,r,i){T=!0;const s=R,o=!a.getItem("bufferTabId")&&te("chunk")||"false",c=window.performance.getEntriesByType("navigation").map((e=>e.type)).includes("reload"),l=window.performance.getEntriesByType("navigation").map((e=>e.type)).includes("back_forward");et(),e.sendFileMetaData("metadata",k,d,o,encodeURI(s),P,t.origin,c||l),Ze(),n?n.then((a=>{e.sendInitialBuffer("initialBuffer",a.startTime,a.endTime,a.buffer,t.origin),xe(a)})).catch((a=>{e.sendInitialBuffer("initialBuffer",0,0,-1,t.origin),m.error("Linearization InitialBuffer Failed")})):e.sendInitialBuffer("initialBuffer",0,0,-1,t.origin),Oe(e,t,r,i),be("Viewer loaded")}(t,s,r,n,i),ae({main_op:"getUserInfoFromAcrobat"},(e=>{D._sendMessage({type:"adobeYoloUserData",...e},L.origin)})),s.data.visitorID){const t=e.getItem("viewerVisitorID");e.setItem("viewerVisitorID",s.data.visitorID),t&&t!==s.data.visitorID&&ce("DCBrowserExt:Analytics:viewerVisitorID:MCMID:Changed")}break;case"getFileBufferRange":!function(e,t){let a={url:R};b.getFileBufferRange(a,e.data.range).then((a=>{B||(B=!0),t.sendBufferRanges("bufferRanges",`${e.data.range.start}-${e.data.range.end}`,a.buffer,e.origin)})).catch((a=>{ce("DCBrowserExt:Viewer:Error:Linearization:Range:Failed"),t.sendBufferRanges("bufferRanges",`${e.data.range.start}-${e.data.range.end}`,-1,e.origin)}))}(s,t);break;case"previewFailed":A||(ce("DCBrowserExt:Viewer:Error:FallbackToNative:Preview:Failed"),A=!0,se());break;case"lastUserGuid":e.setItem("lastUserGuid",s.data.value);break;case"signin":ce("DCBrowserExt:Viewer:Ims:Sign:In"),ge();break;case"signout":ce("DCBrowserExt:Viewer:Ims:Sign:Out"),e.removeItem("viewer-locale"),e.removeItem("userDetailsFetchedTimeStamp"),e.removeItem("discoveryExpiryTime"),e.removeItem("viewer-locale"),Ae(s.data.fileBuffer,pe);break;case"googleAppsPrintShown":a.setItem("googleAppsPrint","false"),ce("DCBrowserExt:Viewer:GoogleApps:Print:Shown");break;case"signInExperimentShown":chrome.tabs.query({active:!0,currentWindow:!0},(function(t){const a=t[0],n=(new Date).getTime();e.setItem("signInExperimentShown",JSON.stringify({currTabId:a.id,timestamp:n}))}));break;case"disableViewer":e.setItem("pdfViewer","false"),chrome.tabs.reload();break;case"signInExperimentClosed":case"signInExperimentSkipped":e.setItem("signInExperimentSuppressed","true");break;case"enableBeta":e.setItem("betaOptOut","false"),chrome.tabs.reload();break;case"disableBeta":e.setItem("betaOptOut","true"),chrome.tabs.reload();break;case"updateTitle":$e(s.data.title);break;case"viewer_set_item":We(s.data.key,s.data.value,s.data.startup);break;case"viewer_remove_item":He(s.data.key)}}}catch(e){ce("DCBrowserExt:Viewer:Error:MessageHandler:Unknown")}}}function je(){if(!U)return ce("DCBrowserExt:Viewer:Error:Handshake:TimedOut"),se(),!1}const ze=t=>{try{e.getItem("enableCSRF")&&ye();const n=$.getHeaderValue("content-length");d=n;const r=$.getHeaderValue("accept-ranges"),i=r&&"bytes"===r.toLowerCase();R=t.originalUrl,Re(),P=function(){let e;const t=$.getHeaderValue("content-disposition");if(t&&/\.pdf(["']|$)/i.test(t)){const a=/filename[^;=\n\*]?=((['"]).*?\2|[^;\n]*)/.exec(t);null!=a&&a.length>1&&(e=a[1].replace(/['"]/g,""))}return e||(e=Ee(R)),decodeURIComponent(e)}();const s={url:R},o=new URL(e.getItem("cdnUrl"));L||(L=o);let c=null;const l="false"!==te("linearization")&&!a.getItem("bufferTabId");l&&i&&n>0&&(c=b.getFileBufferRange(s,{start:0,end:1024})),window.addEventListener("message",Ge(D,t,c)),Qe(),setTimeout(je,25e3)}catch(e){be("InitMimeHandlerScript failed",e),se()}},qe=e=>e&&new URLSearchParams(e)?.has(S),Je=e=>"https://drive.usercontent.google.com"===e?.origin&&e?.searchParams?.has(S),Ye=e=>chrome.runtime.sendMessage({main_op:"getFloodgateFlag",flag:e}),Ke=()=>{try{if(R&&qe(R)){const t=ne(new URL(R)?.search,S),a=_e(t),n="true"===e.getItem(`${a}-pdf-default-viewership`);Promise.all([Ye(`dc-cv-${a}-default-viewership`),Ye(`dc-cv-${a}-default-viewership-control`)]).then((([e,r])=>{!function(e,t){const a={main_op:"analytics"};a.analytics=[[e]],t&&a.analytics[0].push(t),ae(a)}(`DCBrowserExt:Viewer:ExtnViewerPdfOpened:${t}`,v(n,e,a,e||r))}))}}catch(e){}},Xe=async()=>{try{if(e.getItem("enableCSRF")&&ye(),!ee(R))return void(E=!1);Re();const t=te("clen")||-1,n=te("chunk")||!1,r="false"!==te("linearization")&&!a.getItem("bufferTabId"),i={url:R},s=(new Date).getTime(),o=new URL(e.getItem("cdnUrl"));P=te("pdffilename"),P=P?encodeURIComponent(P):Ee(R),document.title=decodeURIComponent(P),L||(L=o);let c=null;const d=r&&n&&t>0;d&&(c=b.getFileBufferRange(i,{start:0,end:1024}));const l=De(),m=(await l).buffer?l:function(e,t,a){return new Promise(((n,r)=>{const i=R;if(i.startsWith("file://"))return void ke(i,n);const s=new XMLHttpRequest;s.open("GET",i),s.responseType="arraybuffer",t&&s.setRequestHeader("If-Range","randomrange"),s.onreadystatechange=Te(s,i),s.onprogress=Ue(e,a),s.onload=()=>{if(s.status>=200&&s.status<400)n({buffer:s.response,mimeType:s.getResponseHeader("content-type"),downLoadEndTime:(new Date).getTime()}),Ce(s.response);else{const e={status:s.status,statusText:s.statusText};r({message:"Invalid response fetching content",error:e})}},s.onerror=e=>{r({message:"Error to download file contents",error:e})},s.ontimeout=e=>{r({message:"Timeout to download file contents",error:e})},s.send()}))}(D,d,o.origin);window.addEventListener("message",Ge(D,m,c,s)),setTimeout(je,25e3),Ke()}catch(e){be("InitScript failed",e),se()}};function Ze(){if(a.getItem("signInAction")){const e=a.getItem("signInAction");D._sendMessage({type:"signInInformation",action:e,source:"signIn"===e?a.getItem("signInSource"):a.getItem("signUpSource")},L.origin),a.removeItem("signInSource"),a.removeItem("signUpSource"),a.removeItem("signInAction")}}async function Qe(){chrome.storage.onChanged.addListener(((t,a)=>{"local"===a&&Object.entries(t).forEach((([t,{newValue:a}])=>{switch(t){case"theme":D._sendMessage({type:"themeChange",theme:a},L.origin);break;case"ANALYTICS_OPT_IN_ADMIN":{const t="false"!==e.getItem("logAnalytics"),n="false"!==a;D._sendMessage({type:"analyticsTrackingChange",value:t&&n},L.origin);break}case"saveLocation":D._sendMessage({type:"changeSaveLocationPreference",saveLocation:a},L.origin);break;case"isDarkPageThemeEnabled":D._sendMessage({type:"darkPageThemeChange",isDarkPageThemeEnabled:a},L.origin);break;case"egaf":D._sendMessage({type:"enableGenAIFeaturesToggled",enableGenAIFeatures:a},L.origin);break;case"akamai":ae({main_op:"reRegisterUninstallUrl"})}}))})),await async function(){return _=await i.isInstalledViaUpsell(),_}(),D._sendMessage({type:"setAsyncStorage",storage:e.getItem("viewerStorageAsync")},L.origin),ae({main_op:"viewer-startup",url:R,startup_time:Date.now(),viewer:!0},(e=>{Ie.isSharePointURL=!!e.isSharePointURL,Ie.isSharePointFeatureEnabled=!!e.isSharePointEnabled,Ie.isFrictionlessEnabled=!!e.isFrictionlessEnabled,Ie.featureFlags=e.featureFlags,Ie.isFillAndSignRegisteryEnabled=e.isFillnSignEnabled;const t=le().href;D.sendStartupConfigs(t,L.origin)})),ae({main_op:"get-features&groups",cachePurge:"LAZY"},(e=>{D._sendMessage({type:"featureGroups",featureGroups:e.featureGroups,featureFlags:e.featureFlags,ffResponse:e.ffResponse},L.origin)})),M?setTimeout((()=>Pe("loadedTabsInfo",V)),2e3):ae({main_op:"updateLoadedTabsInfo"}),H.writeAndSyncWithHistory(R,{filename:P,lastVisited:Date.now()})}function et(){D._sendMessage({type:"fgFlagsResponse",ffResponse:e.getItem("ffResponse_anon")||"{}",anonUserUUID:e.getItem("anonUserUUID")},L.origin)}function tt(e){ae({main_op:"caret_mode_toggle_handler",toggleCaretModeValue:e})}function at(t,a,n){switch(t.panel_op&&!0===t.reload_in_native&&(delete t.is_viewer,chrome.tabs.reload(t.tabId)),t.content_op){case"showLocalFileAccessToast":t.tabId&&t.tabId!==e.getItem("lastOpenTabId")||D._sendMessage({type:"showLocalFileAccessToast"},L.origin);break;case"rapidRenditionResponse":D._sendMessage({type:"rapidRenditionResponse",pageRendition:t.pageRendition,perfMarker:t.perfMarker},L.origin);break;case"rapidRenditionError":D._sendMessage({type:"rapidRenditionError",error:t.error},L.origin)}switch(t.main_op){case"relay_to_content":if("dismiss"===t.content_op){delete t.content_op,delete t.reload_in_native;let e=document.getElementById("__acrobatDialog__");return void(e&&(e.remove(),e=null))}"caret_mode_toggle_handler"===t.content_op&&D._sendMessage({type:"toggleCaretMode",toggleCaretModeValue:t.status},L.origin);break;case"reset":D._sendMessage({type:"toggleAnalytics",logAnalytics:t.analytics_on},L.origin);break;case"showUninstallPopUp":D._sendMessage({type:"showUninstallPopUp"},L.origin);break;case"jumpUrlSuccess":(!M||t.tabInfo&&t.tabInfo.includes(V))&&D._sendMessage({type:"adobeYoloJumpUrlSuccess"},L.origin);break;case"triggerBufferSave":D._sendMessage({type:"triggerBufferSave"},L.origin);break;case"downloadFileSuccess":D._sendMessage({type:"downloadFileSuccess"},L.origin);break;case"openViewerAIAssistant":D._sendMessage({type:"openViewerAIAssistant"},L.origin);break;case"isGenAIEligibleInCDN":if(t.activeTabId==G)return Z.then(n),!0}return!1}function nt(){const t=e.getItem("userState");let a=!1;if(void 0!==t?.rvu&&(a=!0),!0!==t.rvu){const t={rvu:a};e.setItem("userState",t)}}document.addEventListener("DOMContentLoaded",function(e){const t=(new Date).getTime();let a=window.setInterval((function(){(function(){const e=document.getElementById("dc-view-frame");return e&&e.contentWindow&&1===e.contentWindow.length}()||(new Date).getTime()-t>15e3)&&(window.clearInterval(a),e.call(this))}),200)}((function(){const e=document.getElementById("dc-view-frame");e&&e.contentWindow&&e.contentWindow.focus()}))),void 0!==chrome.runtime&&(H=new h,i.isMimeHandlerAvailable().then((async function(t){if(chrome.runtime.onMessage.addListener(at),t){if(M=!0,!window.navigator.onLine&&e.getItem("offlineSupportDisable"))return void se();e.getItem("sessionStarted")||(e.setItem("sessionId",n.uuid()),e.setItem("sessionStarted",!0));const t=await i.getStreamInfo()||{};$=new f(t.responseHeaders),V=t.tabId;let a=await ae({main_op:"check-is-google-print"});x=a&&a.isGooglePrint,N=await i.caretModeStatus(),i.addCaretModeListener(tt),ae({main_op:"viewer-preview",startup_time:Date.now(),viewer:!0},(()=>ze(t)));const r=$.getHeaderValue("content-length"),s=$.getHeaderValue("accept-ranges"),o=s&&"bytes"===s.toLowerCase();r>0&&o&&ae({main_op:"setupWorkerOffscreen",pdfURL:t.originalUrl,pdfSize:+r,acceptRanges:o});e.getItem("firstOpenedTabId")||e.setItem("firstOpenedTabId",V)}else re(),Xe(),Qe()})))}();