/*************************************************************************
* ADOBE CONFIDENTIAL
* ___________________
*
*  Copyright 2015 Adobe Systems Incorporated
*  All Rights Reserved.
*
* NOTICE:  All information contained herein is, and remains
* the property of Adobe Systems Incorporated and its suppliers,
* if any.  The intellectual and technical concepts contained
* herein are proprietary to Adobe Systems Incorporated and its
* suppliers and are protected by all applicable intellectual property laws,
* including trade secret and or copyright laws.
* Dissemination of this information or reproduction of this material
* is strictly forbidden unless prior written permission is obtained
* from Adobe Systems Incorporated.
**************************************************************************/
import expressFteUtils from"./express-fte-utils.js";import{dcLocalStorage}from"../../common/local-storage.js";class ExpressFte{EXPRESS_FTE_CONSTANTS={POPOVER_FTE_CLASSNAME_PREFIX:"a129d813",ALLOWLISTED_DOMAINS:["imgur.*","*.imgur.*","unsplash.*","*.unsplash.*","pixabay.*","*.pixabay.*","pexels.*","*.pexels.*","istockphoto.*","*.istockphoto.*","stockvault.*","*.stockvault.*","picjumbo.*","*.picjumbo.*","google.*","www.google.*"],COACHMARK_IMAGES:["browser/images/ExpressRemoveBackground.png","browser/images/ExpressCropImage.png","browser/images/ExpressApplyEffects.png"]};constructor(){this.expressInitPromise=chrome.runtime.sendMessage({main_op:"express-init"}),this.addFontPromise=expressFteUtils.addFontToDocument(),this.expressInitPromise.then((e=>{this.rightClickOnImageAnalytics(e),this.mergedAllowList=this.EXPRESS_FTE_CONSTANTS.ALLOWLISTED_DOMAINS,e?.allowInfo?.allowListArray&&(this.mergedAllowList=this.mergedAllowList.concat(e.allowInfo.allowListArray))}))}rightClickOnImageAnalytics(e){e?.enableRightClickOnImageAnalytics&&window.addEventListener("contextmenu",(e=>{"IMG"===e.target.tagName.toUpperCase()&&chrome.runtime.sendMessage({main_op:"analytics",analytics:[["DCBrowserExt:Express:ContextMenu:OnImage:Opened"]]})}))}showFteIfEligible(){let e=0,t=setInterval((async()=>{try{const s=await this.expressInitPromise;await dcLocalStorage.init();if(await this.isExpressFteEligible()){const e=this.createPopoverFTE({title:s.expressTooltipStrings.popoverTitle,description:s.expressTooltipStrings.popoverDescription});return document.body.appendChild(e),void clearInterval(t)}e+=1,e>=4&&clearInterval(t)}catch(e){clearInterval(t)}}),500)}async isExpressFteEligible(){const e=await this.expressInitPromise;if(!e.showExpressTooltip)return!1;if(!this.inURLList(this.mergedAllowList,window.location.hostname))return!1;const t=dcLocalStorage.getItem("expressFTEShown");if(3===t?.shownCount)return!1;if(t?.lastShownAt){let e=new Date(t.lastShownAt);await expressFteUtils.isExpressFteTooltipSecond()?e.setSeconds(e.getSeconds()+7):e.setDate(e.getDate()+7);if(new Date<e)return!1}const s=document.getElementsByTagName("img");let o=!1;for(let t of s){if(t.offsetHeight<e.imageDimension.height||t.offsetWidth<e.imageDimension.width)continue;const s=t.getBoundingClientRect();if(!(s.top<0||s.left<0||s.right>window.innerWidth||s.bottom>window.innerHeight)&&this.isInteractiveImage(t)){o=!0;break}}return o}inURLList(e,t){for(let s of e){const e=new RegExp("^"+s.replaceAll(".","\\.").replaceAll("*",".*")+"$");if(t.match(e))return!0}return!1}postShowCoachmarkUpdate(){const e=new URL(window.location.href).hostname;expressFteUtils.sendAnalyticsEvent([["DCBrowserExt:Express:PopoverCoachmark:Shown",{domain:e}]]),this.updateChromeStoreInfo()}hideShowCoachmarkUpdate(){expressFteUtils.sendAnalyticsEvent([["DCBrowserExt:Express:PopoverCoachmark:Dismissed"]])}async updateChromeStoreInfo(){const e=dcLocalStorage.getItem("expressFTEShown");let t=0;t=""===e?1:(e?.shownCount||0)+1;const s={lastShownAt:(new Date).toISOString(),shownCount:t};dcLocalStorage.setItem("expressFTEShown",s)}isInteractiveImage(e){const t=e.getBoundingClientRect(),s=document.elementsFromPoint(t.x+t.width/2,t.y+t.height/2);for(let o of s){if("A"===o.tagName||"INPUT"===o.tagName){if(o.contains(e)){if(o.clientHeight>=t.height&&o.clientWidth>=t.width)return!1;continue}return!1}return!!e.isSameNode(o)}return!1}createAcrobatIconElement=e=>{const t=document.createElement("img");return t.setAttribute("src",chrome.runtime.getURL("browser/images/acrobat_dc_appicon_128.png")),t.setAttribute("class",`${e}-tooltip-icon`),t};createImageContainer(){const e=document.createElement("div");e.setAttribute("class",`${this.EXPRESS_FTE_CONSTANTS.POPOVER_FTE_CLASSNAME_PREFIX}-image-container`);const t=document.createElement("img"),s=dcLocalStorage.getItem("expressFTEShown")?.shownCount||0;return t.setAttribute("src",chrome.runtime.getURL(this.EXPRESS_FTE_CONSTANTS.COACHMARK_IMAGES[s%this.EXPRESS_FTE_CONSTANTS.COACHMARK_IMAGES.length])),t.setAttribute("class",`${this.EXPRESS_FTE_CONSTANTS.POPOVER_FTE_CLASSNAME_PREFIX}-coachmark-image`),e.appendChild(t),e}createCloseButton(e){const t=document.createElement("div"),s=document.createElement("img");return s.setAttribute("class",`${this.EXPRESS_FTE_CONSTANTS.POPOVER_FTE_CLASSNAME_PREFIX}-close-button-icon`),s.src=chrome.runtime.getURL("browser/images/cross_10_n.svg"),t.appendChild(s),t.setAttribute("class",`${this.EXPRESS_FTE_CONSTANTS.POPOVER_FTE_CLASSNAME_PREFIX}-close-button`),t.addEventListener("click",(()=>{document.body.removeChild(e),this.hideShowCoachmarkUpdate()})),t}createContentContainer(e){const t=document.createElement("div");t.setAttribute("class",`${this.EXPRESS_FTE_CONSTANTS.POPOVER_FTE_CLASSNAME_PREFIX}-content-container`);const s=document.createElement("div");s.setAttribute("class",`${this.EXPRESS_FTE_CONSTANTS.POPOVER_FTE_CLASSNAME_PREFIX}-express-header`);const o=this.createAcrobatIconElement(`${this.EXPRESS_FTE_CONSTANTS.POPOVER_FTE_CLASSNAME_PREFIX}-express`),n=document.createElement("div");n.setAttribute("class",`${this.EXPRESS_FTE_CONSTANTS.POPOVER_FTE_CLASSNAME_PREFIX}-header-content`),n.textContent=e.title,s.appendChild(o),s.appendChild(n);const i=document.createElement("div");return i.setAttribute("class",`${this.EXPRESS_FTE_CONSTANTS.POPOVER_FTE_CLASSNAME_PREFIX}-description-content`),i.textContent=e.description,t.appendChild(s),t.appendChild(i),t}createPopoverFTE(e){const t=document.createElement("div");t.setAttribute("class",`${this.EXPRESS_FTE_CONSTANTS.POPOVER_FTE_CLASSNAME_PREFIX}-express-tooltip`);const s=this.createImageContainer();t.appendChild(s);const o=this.createCloseButton(t);t.appendChild(o);const n=this.createContentContainer(e);return t.appendChild(n),this.postShowCoachmarkUpdate(),t}}const expressFte=new ExpressFte;export default expressFte;